# HAProxy Configuration for KumoMTA Load Balancing
# Smarter Outbound Enterprise Email Infrastructure

global
    # Global settings
    daemon
    maxconn 10000
    log stdout format raw local0 info
    
    # Performance tuning
    tune.ssl.default-dh-param 2048
    tune.bufsize 32768
    tune.maxrewrite 8192
    
    # Security
    chroot /var/lib/haproxy
    stats socket /var/lib/haproxy/stats mode 600 level admin
    user haproxy
    group haproxy

defaults
    # Default settings for all sections
    mode tcp
    option tcplog
    option dontlognull
    timeout connect 5000
    timeout client 50000
    timeout server 50000
    log global

# Frontend for SMTP (port 2525)
frontend smtp_frontend
    bind *:2525
    mode tcp
    option tcplog
    
    # Health check
    option tcp-check
    
    # Rate limiting
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    
    # Backend selection
    default_backend smtp_backend

# Frontend for SMTP Submission (port 2587)
frontend smtp_submission_frontend
    bind *:2587
    mode tcp
    option tcplog
    
    # Health check
    option tcp-check
    
    # Rate limiting
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    
    # Backend selection
    default_backend smtp_submission_backend

# Frontend for HTTP API (port 8000)
frontend http_api_frontend
    bind *:8000
    mode http
    option httplog
    
    # Health check
    option httpchk GET /health
    
    # Rate limiting
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    
    # Backend selection
    default_backend http_api_backend

# Frontend for HAProxy Stats (port 8080)
frontend stats_frontend
    bind *:8080
    mode http
    option httplog
    
    # Stats page
    stats enable
    stats uri /stats
    stats refresh 30s
    stats show-legends
    stats admin if TRUE
    
    # Basic authentication
    stats auth admin:admin123

# Backend for SMTP (port 25)
backend smtp_backend
    mode tcp
    option tcp-check
    balance roundrobin
    option redispatch
    retries 3
    
    # Health check
    option tcp-check
    
    # Server definitions
    server kumod-1 kumod-1:25 check inter 10s rise 2 fall 3
    server kumod-2 kumod-2:25 check inter 10s rise 2 fall 3
    server kumod-3 kumod-3:25 check inter 10s rise 2 fall 3

# Backend for SMTP Submission (port 587)
backend smtp_submission_backend
    mode tcp
    option tcp-check
    balance roundrobin
    option redispatch
    retries 3
    
    # Health check
    option tcp-check
    
    # Server definitions
    server kumod-1 kumod-1:587 check inter 10s rise 2 fall 3
    server kumod-2 kumod-2:587 check inter 10s rise 2 fall 3
    server kumod-3 kumod-3:587 check inter 10s rise 2 fall 3

# Backend for HTTP API
backend http_api_backend
    mode http
    balance roundrobin
    option redispatch
    retries 3
    
    # Health check
    option httpchk GET /health
    
    # Server definitions
    server kumod-1 kumod-1:8000 check inter 10s rise 2 fall 3
    server kumod-2 kumod-2:8000 check inter 10s rise 2 fall 3
    server kumod-3 kumod-3:8000 check inter 10s rise 2 fall 3

# Listen section for monitoring
listen monitoring
    bind *:8081
    mode http
    option httplog
    
    # Health check endpoint
    http-request use-service prometheus-exporter if { path /metrics }
    
    # Custom health check
    http-request return status 200 content-type "text/plain" string "OK" if { path /health }
    
    # Default response
    http-request return status 404 content-type "text/plain" string "Not Found"

# Prometheus exporter configuration
frontend prometheus_exporter
    bind *:8082
    mode http
    option httplog
    
    # Prometheus metrics
    http-request use-service prometheus-exporter if { path /metrics }
    
    # Default response
    http-request return status 404 content-type "text/plain" string "Not Found"
